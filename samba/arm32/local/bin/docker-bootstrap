#!/bin/sh

set -e

if [ -e /.init ]; then
	exit
fi

touch /.init

mkdir -p /conf.d/samba

USER_NAME=${USER_NAME:-forumi0721}
USER_PASSWD=$([ ! -z "${USER_EPASSWD}" ] && echo ${USER_EPASSWD} | base64 -d 2>/dev/null || echo ${USER_PASSWD:-passwd})
USER_UID=${USER_UID:-1000}
USER_GID=${USER_GID:-100}

docker-adduser -u ${USER_UID} -g ${USER_GID} -H /dev/null -S /sbin/nologin -R ${USER_NAME}

echo "${USER_NAME}:${USER_PASSWD}" | chpasswd &> /dev/null

if [ ! -s /conf.d/samba/smb.conf ]; then
	NETBIOS_NAME=${NETBIOS_NAME:-SAMBA}
	WORKGROUP=${WORKGROUP:-WORKGROUP}
	SAMBA_SHARE=${SAMBA_SHARE:-data:/data}

	cat << EOF > /tmp/smb.conf
[global] 
	netbios name = ${NETBIOS_NAME} 
	workgroup = ${WORKGROUP} 
	server string = Samba %v in an Docker container 
	security = user 
	auth methods =
	client lanman auth = No
	client NTLMv2 auth = Yes
	client plaintext auth = No
	lanman auth = No
	ntlm auth = Yes
	raw NTLMv2 auth = Yes
	guest account = nobody 
	#map to guest = Bad User 
	map to guest = never
	max protocol = SMB3
	
	# disable printing services 
	load printers = no 
	printing = bsd 
	printcap name = /dev/null 
	disable spoolss = yes 

	# performance
	strict allocate = Yes
	allocation roundup size = 4096
	read raw = Yes
	write raw = Yes
	strict locking = No
	socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=131072 SO_SNDBUF=131072
	min receivefile size = 16384
	use sendfile = Yes
	aio read size = 16384
	aio write size = 16384

EOF

	for share in $(echo ${SAMBA_SHARE} | sed -e "s/,/\n/g")
	do
		share_name="$(echo "${share}" | sed -e "s/^\([^=]*\)=\?\(.*\)$/\1/g")"
		share_path="$(echo "${share}" | sed -e "s/^\([^=]*\)=\?\(.*\)$/\2/g")"
		if [ -z "${share_path}" ]; then
			share_path="${share_name}"
			share_name="$(basename "${share_path}")"
		fi
		cat << EOF >> /tmp/smb.conf
[${share_name}] 
	comment = ${share_name} 
	path = ${share_path}
	read only = no
	write list = ${USER_NAME} 
	force user = ${USER_NAME}
	guest ok = yes 

EOF
	done

	cat /tmp/smb.conf > /conf.d/samba/smb.conf
	rm -rf /tmp/smb.conf
fi

if [ -z "$(pdbedit ${USER_NAME} 2> /dev/null)" ]; then
	echo -e "${USER_PASSWD}\n${USER_PASSWD}" | smbpasswd -a -s -c /conf.d/samba/smb.conf ${USER_NAME}
else
	echo -e "${USER_PASSWD}\n${USER_PASSWD}" | smbpasswd -s -c /conf.d/samba/smb.conf ${USER_NAME}
fi

